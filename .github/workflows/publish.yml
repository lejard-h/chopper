name: Publish packages

on:
  push:
    branches:
      - master
defaults:
  run:
    shell: bash
env:
  PUB_ENVIRONMENT: bot.github
permissions: read-all

jobs:
  publish:
    name: "Publish package"
    runs-on: ubuntu-latest
    strategy:
      matrix:
        package: [ chopper, chopper_generator, chopper_built_value ]
    steps:
      - uses: dart-lang/setup-dart@v1
        with:
          sdk: stable
      - id: checkout
        uses: actions/checkout@v3
      - name: Load version
        id: load_version
        run: |
          echo "APP_VERSION=$(awk '/^version: / {print $2}' ${{ matrix.package }}/pubspec.yaml)" >> $GITHUB_ENV
      - name: Compare versions
        id: compare_versions
        run: |
          echo "::set-output name=IS_VERSION_GREATER::$(echo $APP_VERSION ${GITHUB_HEAD_REF:-HEAD} | awk '{print $1>$2}')"
      - name: Set up pub credentials
        id: credentials
        if: ${{ steps.compare_versions.outputs.IS_VERSION_GREATER == 'true' }}
        run: |
          mkdir -p $XDG_CONFIG_HOME/dart
          echo '${{ secrets.CREDENTIAL_JSON }}' > "$XDG_CONFIG_HOME/dart/pub-credentials.json"
      - name: Publish
        id: publish
        if: ${{ steps.compare_versions.outputs.IS_VERSION_GREATER == 'true' }}
        run: bash tool/publish.sh ${{ matrix.package }}
      - name: Published version is up to date
        id: version_up_to_date
        if: ${{ steps.compare_versions.outputs.IS_VERSION_GREATER != 'true' }}
        run: echo "Published version is up to date. Will not publish."