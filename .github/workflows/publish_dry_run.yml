name: Publish packages (dry run)

on:
  pull_request:
    branches:
      - master
      - develop # TODO: only here for testing the job
defaults:
  run:
    shell: bash
env:
  PUB_ENVIRONMENT: bot.github
permissions: read-all

jobs:
  get_base_version:
    name: "Get base version"
    runs-on: ubuntu-latest
    strategy:
      matrix:
        package: [ chopper, chopper_generator, chopper_built_value ]
    steps:
      - uses: dart-lang/setup-dart@v1
        with:
          sdk: stable
      - id: checkout
        uses: actions/checkout@v3
        with:
          ref: ${{ github.event.pull_request.base.ref }}
      - name: Load base version
        id: load_base_version
        run: |
          echo "BASE_VERSION=$(awk '/^version: / {print $2}' ${{ matrix.package }}/pubspec.yaml)" >> $GITHUB_OUTPUT
          cat $GITHUB_ENV
  publish_dry_run:
    name: "Publish DRY RUN"
    needs: get_base_version
    runs-on: ubuntu-latest
    strategy:
      matrix:
        package: [ chopper, chopper_generator, chopper_built_value ]
    steps:
      - env:
          BASE_VERSION: ${{ needs.get_base_version.outputs.BASE_VERSION }}
      - uses: dart-lang/setup-dart@v1
        with:
          sdk: stable
      - id: checkout
        uses: actions/checkout@v3
      - name: Load this version
        id: load_this_version
        run: |
          echo "THIS_VERSION=$(awk '/^version: / {print $2}' ${{ matrix.package }}/pubspec.yaml)" >> $GITHUB_ENV
      - name: Compare versions
        id: compare_versions
        run: |
          function version() {
            echo $1 | awk -F. '{ printf("%d%03d%03d%03d\n", $1,$2,$3,$4); }';
          }
          
          if [ $(version $THIS_VERSION) -gt $(version $BASE_VERSION) ]; then
              echo "IS_VERSION_GREATER=1" >> $GITHUB_ENV
          else
              echo "IS_VERSION_GREATER=0" >> $GITHUB_ENV
          fi
          
          cat $GITHUB_ENV
      - name: Publish (dry run)
        id: publish_dry_run
        if: ${{ env.IS_VERSION_GREATER == 1 }}
        run: bash tool/publish.sh ${{ matrix.package }} --dry-run
      - name: Skip publish (dry run)
        if: ${{ env.IS_VERSION_GREATER == 0 }}
        run: echo "Skipping publish (dry run) for ${{ matrix.package }} because the version is not greater than the one on pub.dev"